<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Comercial - Málaga</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600;800&display=swap" rel="stylesheet">
    <style>
    :root {
        --bg-deep: #0a0e14;
        --bg-card: #141b26;
        --corporate-blue: #0056b3; 
        --soft-blue: #3a86ff;
        --gold: #d4af37;
        --silver: #aaa9ad;
        --bronze: #cd7f32;
        --text-main: #ffffff;
        --text-dim: #94a3b8;
        --border: #2d3748;
    }

    body {
        font-family: 'Outfit', sans-serif;
        background-color: var(--bg-deep);
        color: var(--text-main);
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .dashboard-container {
        display: grid;
        grid-template-columns: 1.2fr 2.5fr 1.3fr;
        gap: 20px;
        padding: 25px;
        flex-grow: 1;
    }

    .card {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 30px;
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    .title-section {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-bottom: 25px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 10px;
    }

    /* --- RANKING DESTACADO --- */
    .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid transparent;
    }

    /* TOP 3: Estilos Especiales */
    .ranking-item:nth-child(1) { 
        background: rgba(0, 86, 179, 0.2); 
        border: 1px solid var(--corporate-blue);
        padding: 18px 15px;
    }
    .ranking-item:nth-child(1) .name { color: #fff; font-size: 1.5rem; font-weight: 800; }
    .ranking-item:nth-child(1) .val { color: var(--soft-blue); font-size: 1.8rem; }

    .ranking-item:nth-child(2) { 
        background: rgba(255, 255, 255, 0.05); 
        border-left: 4px solid var(--silver);
    }
    .ranking-item:nth-child(2) .name { font-size: 1.35rem; font-weight: 700; }

    .ranking-item:nth-child(3) { 
        background: rgba(255, 255, 255, 0.03); 
        border-left: 4px solid var(--bronze);
    }
    .ranking-item:nth-child(3) .name { font-size: 1.25rem; font-weight: 700; }

    .name { font-weight: 500; font-size: 1.1rem; color: var(--text-dim); }
    .val { font-weight: 800; color: var(--text-main); font-size: 1.2rem; }

    /* --- CENTRO --- */
    .center-card { justify-content: center; align-items: center; text-align: center; }
    .office-label { background: var(--corporate-blue); padding: 6px 20px; border-radius: 4px; font-size: 0.8rem; font-weight: 800; margin-bottom: 15px; }
    .main-title { font-size: 3.5rem; font-weight: 800; margin: 0; color: var(--text-main); }
    .big-number { font-size: 16rem; font-weight: 900; line-height: 0.9; margin: 20px 0; }
    
    .progress-box { width: 80%; margin-top: 20px; }
    .progress-bg { background: #1e2530; height: 18px; border-radius: 10px; overflow: hidden; margin: 10px 0; }
    .progress-fill { background: var(--corporate-blue); height: 100%; width: 0%; transition: width 1.5s ease-in-out; }

    /* --- DERECHA --- */
    .team-unit { margin-bottom: 40px; text-align: center; }
    .team-name { font-size: 1.8rem; font-weight: 700; color: var(--text-dim); }
    .team-val { font-size: 6rem; font-weight: 800; color: var(--text-main); display: block; }
    .goal-info { font-size: 0.9rem; color: var(--text-dim); }
</style>
</head>
<body>

<div class="dashboard-container">
    <div class="card">
        <div class="title-section">Ranking de Ventas</div>
        <div id="ranking-list">
            </div>
    </div>

    <div class="card center-card">
        <div class="office-label">DASHBOARD OFICIAL</div>
        <h1 class="main-title">MÁLAGA TOTAL</h1>
        <div class="big-number" id="total-val">0</div>
        
        <div class="progress-box">
            <div style="display: flex; justify-content: space-between; font-weight: 600;">
                <span>PROGRESO</span>
                <span id="percent-total">0%</span>
            </div>
            <div class="progress-bg">
                <div id="bar-total" class="progress-fill"></div>
            </div>
            <div class="goal-info">OBJETIVO DE OFICINA: <span id="goal-total" style="color:white">0</span></div>
        </div>
    </div>

    <div class="card" style="justify-content: center;">
        <div class="title-section">Rendimiento por Equipo</div>
        
        <div class="team-unit">
            <span class="team-name">MÁLAGA 1</span>
            <span class="team-val" id="m1-val">0</span>
            <div class="progress-bg" style="height: 8px; width: 70%; margin: 10px auto;">
                <div id="bar-m1" class="progress-fill"></div>
            </div>
            <span class="goal-info">META: <span id="goal-m1">0</span></span>
        </div>

        <div class="team-unit">
            <span class="team-name">MÁLAGA 3</span>
            <span class="team-val" id="m3-val">0</span>
            <div class="progress-bg" style="height: 8px; width: 70%; margin: 10px auto;">
                <div id="bar-m3" class="progress-fill"></div>
            </div>
            <span class="goal-info">META: <span id="goal-m3">0</span></span>
        </div>
    </div>
</div>

<script>
// Asegúrate de que este es el ID que ves en la barra de tu navegador
const sheetID = '1YjHq1RPcu9OQfPIGZJvzhE0a8PlEi4aaRPrgUoiE0no'; 
const url = `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv&gid=0`;

async function updateDashboard() {
    try {
        const response = await fetch(url + '&t=' + new Date().getTime());
        
        if (!response.ok) {
            console.error('Error al acceder al archivo. Verifica permisos de compartir.');
            return;
        }
        
        const csv = await response.text();
        console.log("Datos recibidos:", csv); // Esto te mostrará en la consola qué está leyendo

        // Usamos una expresión regular más robusta para separar filas y comas
        const rows = csv.split(/\r?\n/).map(row => {
            // Esto ayuda a manejar nombres que puedan contener comas internas
            return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        });

        if (rows.length < 2) {
            console.warn("El archivo parece estar vacío o mal formateado");
            return;
        }

        // --- LÓGICA DE ACTUALIZACIÓN ---

        // 1. Ranking de Comerciales (Columnas B y C -> Índices 1 y 2)
        let comerciales = [];
        for(let i = 1; i < rows.length; i++) {
            let nombre = rows[i][1] ? rows[i][1].replace(/"/g, "").trim() : "";
            let valor = parseInt(rows[i][2]) || 0;
            
            if(nombre !== "") {
                comerciales.push({ nombre, valor });
            }
        }
        comerciales.sort((a, b) => b.valor - a.valor);

        let rankingHtml = '';
        comerciales.forEach((c, index) => {
            rankingHtml += `
                <div class="ranking-item">
                    <span class="name">#${index+1} ${c.nombre}</span>
                    <span class="val">${c.valor}</span>
                </div>`;
        });
        document.getElementById('ranking-list').innerHTML = rankingHtml;

        // 2. Oficina Málaga (Fila 2, Col E y H -> Índices [1][4] y [1][7])
        const total = parseInt(rows[1][4]) || 0;
        const goalT = parseInt(rows[1][7]) || 1;
        
        document.getElementById('total-val').innerText = total;
        document.getElementById('goal-total').innerText = goalT;
        let pTotal = Math.min((total/goalT)*100, 100);
        document.getElementById('bar-total').style.width = pTotal + '%';
        document.getElementById('percent-total').innerText = Math.round(pTotal) + '%';

        // 3. Equipos (M1: [1][6] y [1][7] | M3: [2][6] y [2][7])
        // Ajustamos los índices para asegurar que apunten a las filas correctas
        const m1 = parseInt(rows[1][6]) || 0;
        const gM1 = parseInt(rows[2][7]) || 1; // Objetivo M1 en H3
        const m3 = parseInt(rows[2][6]) || 0;
        const gM3 = parseInt(rows[3][7]) || 1; // Objetivo M3 en H4

        document.getElementById('m1-val').innerText = m1;
        document.getElementById('goal-m1').innerText = gM1;
        document.getElementById('bar-m1').style.width = Math.min((m1/gM1)*100, 100) + '%';

        document.getElementById('m3-val').innerText = m3;
        document.getElementById('goal-m3').innerText = gM3;
        document.getElementById('bar-m3').style.width = Math.min((m3/gM3)*100, 100) + '%';

    } catch (e) { 
        console.error("Error crítico en el script: ", e); 
    }
}

setInterval(updateDashboard, 3000);
updateDashboard();
</script>

</body>
</html>